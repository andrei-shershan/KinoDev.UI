# azure-pipelines.yml
trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: Build
  displayName: 'Build Stage'
  jobs:
  - job: BuildJob
    displayName: 'Build Job'
    steps:
    # Install Node.js
    - task: NodeTool@0
      inputs:
        versionSpec: '16.x'
      displayName: 'Install Node.js'

    # Install dependencies
    - script: npm install
      displayName: 'Install Dependencies'

    # Build the project
    - script: npm run build
      displayName: 'Build React App'

    # Optionally, publish the build output as an artifact
    - publish: build
      artifact: build
      displayName: 'Publish Build Artifacts'

- stage: Test
  displayName: 'Test Stage'
  dependsOn: Build
  jobs:
  - job: TestJob
    displayName: 'Test Job'
    steps:
    # Install Node.js again (each stage is isolated)
    - task: NodeTool@0
      inputs:
        versionSpec: '16.x'
      displayName: 'Install Node.js'

    # Install dependencies (ensure tests run against the same version)
    - script: npm install
      displayName: 'Install Dependencies'

    # Run tests. The additional flag '--watchAll=false' ensures the test runner exits after completion.
    - script: npm run test -- --watchAll=false
      displayName: 'Run Tests'